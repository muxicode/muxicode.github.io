(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{331:function(s,t,a){"use strict";a.r(t);var n=a(14),r=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"高并发的核心工具-协程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#高并发的核心工具-协程"}},[s._v("#")]),s._v(" 高并发的核心工具：协程")]),s._v(" "),t("ul",[t("li",[s._v("协程的本质")]),s._v(" "),t("li",[s._v("协程的调度")])]),s._v(" "),t("h2",{attrs:{id:"为什么要有协程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么要有协程"}},[s._v("#")]),s._v(" 为什么要有协程？")]),s._v(" "),t("h3",{attrs:{id:"进程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#进程"}},[s._v("#")]),s._v(" 进程")]),s._v(" "),t("ul",[t("li",[s._v("操作系统”程序”的最小单位")]),s._v(" "),t("li",[s._v("进程用来占用内存空间")]),s._v(" "),t("li",[s._v("进程相当于厂房，占用工厂空间")])]),s._v(" "),t("h3",{attrs:{id:"线程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#线程"}},[s._v("#")]),s._v(" 线程")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/%E7%BA%BF%E7%A8%8B%E7%90%86%E8%A7%A3.drawio.png",alt:""}})]),s._v(" "),t("ul",[t("li",[s._v("每个进程可以有多个线程")]),s._v(" "),t("li",[s._v("线程使用系统分配给进程的内存，线程之间共享内存")]),s._v(" "),t("li",[s._v("线程用来占用CPU时间")]),s._v(" "),t("li",[s._v("线程的调度需要由系统进行，开销较大")]),s._v(" "),t("li",[s._v("线程相当于工厂的生产线，占用工人的工时")]),s._v(" "),t("li",[s._v("线程里跑的程序就是生产流程")])]),s._v(" "),t("h3",{attrs:{id:"线程的问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#线程的问题"}},[s._v("#")]),s._v(" 线程的问题")]),s._v(" "),t("ul",[t("li",[s._v("线程本身占用资源大（几M数据）")]),s._v(" "),t("li",[s._v("线程的操作开销大（状态转换）")]),s._v(" "),t("li",[s._v("线程切换开销大")])]),s._v(" "),t("h3",{attrs:{id:"协程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#协程"}},[s._v("#")]),s._v(" 协程")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/%E7%90%86%E8%A7%A3%E5%8D%8F%E7%A8%8B.drawio.png",alt:""}})]),s._v(" "),t("ul",[t("li",[s._v("协程就是将一段程序的运行状态打包，可以在线程之间调度")]),s._v(" "),t("li",[s._v("将生产流程打包，使得流程不固定在生产线上")]),s._v(" "),t("li",[s._v("协程并不取代线程，协程也要在线程上运行")]),s._v(" "),t("li",[s._v("线程是协程的资源，协程使用线程这个资源")])]),s._v(" "),t("h3",{attrs:{id:"协程的优势"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#协程的优势"}},[s._v("#")]),s._v(" 协程的优势")]),s._v(" "),t("ul",[t("li",[s._v("资源利用（利用任何线程）")]),s._v(" "),t("li",[s._v("快速调度（快速切换协程）")]),s._v(" "),t("li",[s._v("超高并发")])]),s._v(" "),t("h3",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("ul",[t("li",[s._v("进程用分配内存空间")]),s._v(" "),t("li",[s._v("线程用来分配CPU时间")]),s._v(" "),t("li",[s._v("协程用来精细利用线程")]),s._v(" "),t("li",[s._v("协程的本质是一段包含了运行状态的程序")])]),s._v(" "),t("h2",{attrs:{id:"协程的本质"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#协程的本质"}},[s._v("#")]),s._v(" 协程的本质")]),s._v(" "),t("p",[s._v("runtime2.go/g 结构体")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/go%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84.drawio.png",alt:""}})]),s._v(" "),t("ul",[t("li",[s._v("runtime中，协程的本质是一个g结构体")]),s._v(" "),t("li",[s._v("stack：堆栈地址")]),s._v(" "),t("li",[s._v("gobug：目前程序运行现场")]),s._v(" "),t("li",[s._v("atomicstatus：协程状态")])]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" g "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tstack       stack   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 栈信息高低指针")]),s._v("\n\tsched     gobuf "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 调度信息sp 栈指针（指向调用到的地方，不是方法本身），pc程序计数器，运行到了哪一行代码")]),s._v("\n\tatomicstatus  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 协程的状态")]),s._v("\n\tgoid                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//协程的id号")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("协程本质知道了，但是协程需要放到线程上执行，go里对于线程是怎么描述的呢？")]),s._v(" "),t("p",[s._v("runtime2.go/m 结构体 ------ 我们本身不能创建操作系统的线程，只能用一个结构体记录线程信息")]),s._v(" "),t("h2",{attrs:{id:"线程的抽象"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#线程的抽象"}},[s._v("#")]),s._v(" 线程的抽象")]),s._v(" "),t("ul",[t("li",[s._v("runtime 中将操作系统线程抽象为m结构体")])]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/go%E4%B8%ADm%E7%BB%93%E6%9E%84%E4%BD%93.drawio.png",alt:""}})]),s._v(" "),t("ul",[t("li",[s._v("g0：g0协程，操作调度器")]),s._v(" "),t("li",[s._v("curg: current g, 目前线程运行的g")]),s._v(" "),t("li",[s._v("mOS：操作系统线程信息")])]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" m "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tg0      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// g0协程，用来操作调度器")]),s._v("\n\tcurg    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 当前运行的g 协程")]),s._v("\n    id      "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int64")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 线程的ID")]),s._v("\n\tmOS                   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 不同操作系统，对线程而外的描述信息")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h2",{attrs:{id:"协程是如何在线程上执行的"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#协程是如何在线程上执行的"}},[s._v("#")]),s._v(" 协程是如何在线程上执行的？")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/go%E7%BA%BF%E7%A8%8B%E5%BE%AA%E7%8E%AF.drawio.png",alt:""}})]),s._v(" "),t("p",[s._v("schedule方法 --- runtime/proc.go 下")]),s._v(" "),t("p",[s._v("execute方法 --- runtime/proc.go 下")]),s._v(" "),t("p",[s._v("gogo方法  --- 只看到函数声明，是用汇编实现的。asm_amd64.s")]),s._v(" "),t("p",[s._v("----gobuf_sp(BX), SP 插入goexist栈针")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" schedule "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tgp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" inheritTime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tryWakeP "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("findRunnable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//gp 即将要运行的协程")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("execute")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" inheritTime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//执行gp协程")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("execute")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" inheritTime "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("gogo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("gp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sched"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// func gogo(buf *gobuf)")]),s._v("\nTEXT runtime·"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("gogo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" NOSPLIT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n\tJMP\tgogo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nTEXT gogo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" NOSPLIT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\tMOVQ\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("gobuf_sp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("BX"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" SP\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// restore SP  插入栈针 goexist")]),s._v("\n\tMOVQ\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("gobuf_pc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("BX"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" BX    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 跳到gobuf的程序计数器执行，业务")]),s._v("\n\tJMP\tBX\t\t\t\t        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 使用协程自己的栈记录执行信息")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("栈执行完后，到回到栈底 func goexit(neverCallThisFunction) [runtime/stbs.go/goexit方法] 该方法为汇编实现，至汇编代码goexit：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[s._v("TEXT runtime·"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("goexit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("NOSPLIT"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("TOPFRAME"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\tCALL\truntime·"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("goexit1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// does not return")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Finishes execution of the current goroutine.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("goexit1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mcall")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("goexit0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mcall switches from the g to the g0 stack and invokes fn(g),")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 切换到 g0 的栈空间执行fn")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mcall")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fn "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("goexit0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tgp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("preemptStop "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 设置一下当前运行完毕的协程的状态")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("schedule")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 从 g0 栈开始执行 schedule")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("单线程循（Go 0.X）：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/go%E5%8D%95%E5%BE%AA%E7%8E%AF%E6%8A%BD%E8%B1%A1%E5%9B%BE.drawio.png",alt:""}})]),s._v(" "),t("p",[s._v("多线程循环（Go 1.0）")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/go%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BE%AA%E7%8E%AF%E5%8A%A0%E9%94%81.drawio.png",alt:""}})]),s._v(" "),t("p",[s._v("简略图：")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BE%AA%E7%8E%AF%E7%AE%80%E7%95%A5%E5%9B%BE%E5%8A%A0%E9%94%81.drawio.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"线程循环"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#线程循环"}},[s._v("#")]),s._v(" 线程循环")]),s._v(" "),t("ul",[t("li",[s._v("操作系统并不知道Goroutine的存在")]),s._v(" "),t("li",[s._v("操作系统线程执行一个调度循环，顺序执行Goroutine")]),s._v(" "),t("li",[s._v("调度循环非常像线程池")])]),s._v(" "),t("h3",{attrs:{id:"问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),t("ul",[t("li",[s._v("协程顺序执行，无法并发")]),s._v(" "),t("li",[s._v("多线程并发时，会抢夺协程队列的全局锁")])]),s._v(" "),t("h3",{attrs:{id:"总结-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结-2"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("ul",[t("li",[s._v("协程的本质是一个g结构体")]),s._v(" "),t("li",[s._v("g 结构体记录了协程栈、PC信息")]),s._v(" "),t("li",[s._v("最简情况下，线程执行标准调度循环，执行协程")])]),s._v(" "),t("h2",{attrs:{id:"为什么要有-g-m-p-调度模型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么要有-g-m-p-调度模型"}},[s._v("#")]),s._v(" 为什么要有 G-M-P 调度模型？")]),s._v(" "),t("ul",[t("li",[s._v("协程顺序执行，无法并发")]),s._v(" "),t("li",[t("strong",[s._v("多线程并发时，会抢夺协程队列的全局锁")])])]),s._v(" "),t("h3",{attrs:{id:"本地队列"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#本地队列"}},[s._v("#")]),s._v(" 本地队列")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/%E6%9C%AC%E5%9C%B0%E9%98%9F%E5%88%97.drawio.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"p结构体"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#p结构体"}},[s._v("#")]),s._v(" P结构体")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/P%E7%BB%93%E6%9E%84%E4%BD%93.drawio.png",alt:""}})]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" p "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tm           muintptr   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// m 的指针，指向线程")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Queue of runnable goroutines. Accessed without lock.")]),s._v("\n\trunqhead "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 无锁访问 Accessed without lock")]),s._v("\n\trunqtail    "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("\n\trunq     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("guintptr\n\trunnext guintptr     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 下一个可执行的 g 协程")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("G-M-P 模型")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/GMP%E6%A8%A1%E5%9E%8B.drawio.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"p-的作用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#p-的作用"}},[s._v("#")]),s._v(" P 的作用")]),s._v(" "),t("ul",[t("li",[s._v("M 与 G 之间的中介（送料器）")]),s._v(" "),t("li",[s._v("P 持有一些G，使得每次获取G的时候不用从全局找")]),s._v(" "),t("li",[s._v("大大减少了并发冲突的情况")])]),s._v(" "),t("h3",{attrs:{id:"任务窃取"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#任务窃取"}},[s._v("#")]),s._v(" 任务窃取")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/%E4%BB%BB%E5%8A%A1%E7%AA%83%E5%8F%96.drawio.png",alt:""}})]),s._v(" "),t("p",[s._v("窃取式工作分配机制")]),s._v(" "),t("ul",[t("li",[s._v("如果本地或者全局队列中都找不到G")]),s._v(" "),t("li",[s._v("去别的P中“偷”")]),s._v(" "),t("li",[s._v("增加了线程的利用率")])]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("findRunnable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" inheritTime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tryWakeP "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" gp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" inheritTime "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("runqget")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("_p_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" gp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 本地队列")]),s._v("\n\tgp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("globrunqget")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("_p_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t\t\t     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 全局队列")]),s._v("\n\tgp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" inheritTime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tnow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" w"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" newWork "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stealWork")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("now"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 窃取任务")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h3",{attrs:{id:"新建协程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#新建协程"}},[s._v("#")]),s._v(" 新建协程")]),s._v(" "),t("p",[s._v("runtime/proc.go/newproc")]),s._v(" "),t("ul",[t("li",[s._v("随机寻找一个P")]),s._v(" "),t("li",[s._v("将新的协程放入P的runnext（插队）")]),s._v(" "),t("li",[s._v("若本地队列满，放入全局队列")])]),s._v(" "),t("h3",{attrs:{id:"问题-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题-2"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("协程顺序执行，无法并发")])]),s._v(" "),t("li",[s._v("多线程并发时，会抢夺协程队列的全局锁")])]),s._v(" "),t("h2",{attrs:{id:"如何实现协程的并发问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何实现协程的并发问题"}},[s._v("#")]),s._v(" 如何实现协程的并发问题")]),s._v(" "),t("h3",{attrs:{id:"协程饥饿问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#协程饥饿问题"}},[s._v("#")]),s._v(" 协程饥饿问题")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/%E7%BA%BF%E7%A8%8B%E9%A5%A5%E9%A5%BF%E9%97%AE%E9%A2%98.drawio.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"线程循环-触发切换"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#线程循环-触发切换"}},[s._v("#")]),s._v(" 线程循环-触发切换")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/%E7%BA%BF%E7%A8%8B%E5%BE%AA%E7%8E%AF%E8%A7%A6%E5%8F%91%E5%88%87%E6%8D%A2.drawio.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"全局队列饥饿问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#全局队列饥饿问题"}},[s._v("#")]),s._v(" 全局队列饥饿问题")]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/%E5%85%A8%E5%B1%80%E9%98%9F%E5%88%97%E9%A5%A5%E9%A5%BF%E9%97%AE%E9%A2%98.drawio.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"切换时机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#切换时机"}},[s._v("#")]),s._v(" 切换时机")]),s._v(" "),t("ul",[t("li",[s._v("主动挂起")]),s._v(" "),t("li",[s._v("系统调用完成时")])]),s._v(" "),t("blockquote",[t("p",[s._v("主动挂起: runtime.gopark() -- 切换栈，调回schedule()")])]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/gopark%E4%B8%BB%E5%8A%A8%E6%8C%82%E8%B5%B7.drawio.png",alt:""}})]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[s._v("runtime"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("proc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Puts the current goroutine into a waiting state")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// G cannot be externally readied.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("gopark")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("unlockf "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" unsafe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Pointer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" lock unsafe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Pointer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" reason waitReason"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" traceEv "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("byte")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" traceskip "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tmp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("waitlock "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" lock  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 修改协程状态")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mcall")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("park_m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 切换栈")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// park continuation on g0.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("park_m")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("schedule")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 线程的开始点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("blockquote",[t("p",[s._v("系统调用完成时")])]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%AE%8C%E6%88%90%E6%97%B6.drawio.png",alt:""}})]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[s._v("runtime"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("proc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" \n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("exitsyscall")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Gosched")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Gosched")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mcall")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gosched_m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("gosched_m")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("goschedImpl")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("goschedImpl")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("schedule")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("h3",{attrs:{id:"总结-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结-3"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("ul",[t("li",[s._v("如果协程顺序执行，会有饥饿问题")]),s._v(" "),t("li",[s._v("协程执行中间，将协程挂起，执行其他协程")]),s._v(" "),t("li",[s._v("完成系统调用时挂起（没特殊原因，主要时防止任务一直执行），也可以（runtime）主动挂起")]),s._v(" "),t("li",[s._v("防止全局队列饥饿，本地队列水机抽取全局队列（每执行61次）")])]),s._v(" "),t("p",[s._v("问题")]),s._v(" "),t("ul",[t("li",[s._v("永远都不主动挂起")]),s._v(" "),t("li",[s._v("永远都不系统调用")])]),s._v(" "),t("h2",{attrs:{id:"抢占式调度"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#抢占式调度"}},[s._v("#")]),s._v(" 抢占式调度")]),s._v(" "),t("p",[s._v("思路")]),s._v(" "),t("ul",[t("li",[s._v("有没有一个地方，经常会被调用？")]),s._v(" "),t("li",[s._v("runtime.morestack()")])]),s._v(" "),t("p",[s._v("runtime.morestack")]),s._v(" "),t("ul",[t("li",[s._v("本意是检查协程栈是否有足够空间")]),s._v(" "),t("li",[s._v("调用方法时，会被编译器插入morestack()")])]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" build "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//可以看到汇编调用方法的信息，每次函数跳转都会调用 runtime·morestack_noctxt")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"标记抢占"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#标记抢占"}},[s._v("#")]),s._v(" 标记抢占")]),s._v(" "),t("ul",[t("li",[s._v("系统监控到Goroutine运行超过10ms")]),s._v(" "),t("li",[s._v("将g.stackguard0 置为 0xfffffade")])]),s._v(" "),t("p",[s._v("抢占")]),s._v(" "),t("ul",[t("li",[s._v("执行morestack()判断是否被抢占 --- 系统监控器标记的抢占")]),s._v(" "),t("li",[s._v("如果被抢占，直接回到 schedule()")])]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[s._v("TEXT runtime·"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("morestack_noctxt")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("NOSPLIT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\tJMP\truntime·"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("morestack")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nTEXT runtime·"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("morestack")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("NOSPLIT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\tCALL runtime·"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("newstack")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("newstack")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" preempt "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//  0xfffffade")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("gopreempt_m")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h3",{attrs:{id:"基于协作的抢占式调度"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于协作的抢占式调度"}},[s._v("#")]),s._v(" 基于协作的抢占式调度")]),s._v(" "),t("p",[s._v("问题：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("do")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\ti "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\ti"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 怎么办？")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h3",{attrs:{id:"基于信号的抢占式调度"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于信号的抢占式调度"}},[s._v("#")]),s._v(" 基于信号的抢占式调度")]),s._v(" "),t("ul",[t("li",[s._v("如果永远都不带用morestack()，抢占式调度")]),s._v(" "),t("li",[s._v("基于信号的抢占式调度")])]),s._v(" "),t("blockquote",[t("p",[s._v("线程信号")])]),s._v(" "),t("ul",[t("li",[s._v("操作系统中，有很多基于信号的底层通信方式")]),s._v(" "),t("li",[s._v("比如 SIGPIPE/ SIGURG / SIGHUP")]),s._v(" "),t("li",[s._v("线程可以注册对应信号的处理函数")])]),s._v(" "),t("blockquote",[t("p",[s._v("注册信号")])]),s._v(" "),t("ul",[t("li",[s._v("注册 SIGURG 信号（紧急信号其他地方很少用甚至不用）的处理函数")]),s._v(" "),t("li",[s._v("GC工作时，向目标线程发送信号（GC时很多线程的业务都停了）")]),s._v(" "),t("li",[s._v("线程收到信号，触发调度（func doSigPreempt）")])]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/%E5%9F%BA%E4%BA%8E%E4%BF%A1%E5%8F%B7%E7%9A%84%E6%8A%A2%E5%8D%A0%E5%BC%8F%E8%B0%83%E5%BA%A6.drawio.png",alt:""}})]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("doSigPreempt")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctxt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sigctxt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tasyncPreempt\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nTEXT ·"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("asyncPreempt")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("NOSPLIT"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("NOFRAME"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\tCALL ·"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("asyncPreempt2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("asyncPreempt2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" gp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("preemptStop "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mcall")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("preemptPark"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mcall")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gopreempt_m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("h3",{attrs:{id:"总结-4"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结-4"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("ul",[t("li",[s._v("基于系统调用和主动挂起，协程可能无法调度")]),s._v(" "),t("li",[s._v("基于协作的抢占式调度：业务主动调用morestaack()")]),s._v(" "),t("li",[s._v("基于信号的抢占式调度：强制小城调用doSigPreempt()")])]),s._v(" "),t("h2",{attrs:{id:"实战-协程太多了有什么问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实战-协程太多了有什么问题"}},[s._v("#")]),s._v(" 实战：协程太多了有什么问题？")]),s._v(" "),t("ul",[t("li",[s._v("文件打开数限制")]),s._v(" "),t("li",[s._v("内存限制")]),s._v(" "),t("li",[s._v("调度开销过大")])]),s._v(" "),t("h3",{attrs:{id:"处理协程太多的方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#处理协程太多的方案"}},[s._v("#")]),s._v(" 处理协程太多的方案")]),s._v(" "),t("ul",[t("li",[s._v("优化业务逻辑")]),s._v(" "),t("li",[s._v("利用channel的缓冲区")]),s._v(" "),t("li",[s._v("协程池")]),s._v(" "),t("li",[s._v("调整增加系统的资源")])]),s._v(" "),t("blockquote",[t("p",[s._v("利用channel的缓冲区")])]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TestGoRoutine")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("testing"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("T"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tdo "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ch "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tfmt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),s._v(" ch\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\tch "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("math"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("MaxInt32"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tch "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("do")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ul",[t("li",[s._v("利用channel的缓存机制")]),s._v(" "),t("li",[s._v("启动协程前，向channel送入一个空结构体")]),s._v(" "),t("li",[s._v("协程结束，取出一个空结构体")])]),s._v(" "),t("blockquote",[t("p",[s._v("协程池 （tunny）")])]),s._v(" "),t("ul",[t("li",[s._v("预创建一定数量的协程")]),s._v(" "),t("li",[s._v("将任务送入协程池队列")]),s._v(" "),t("li",[s._v("协程池不断取出可用协程，执行任务")])]),s._v(" "),t("p",[t("img",{attrs:{src:"/high_concurrency_sharps_coroutines.assets/%E5%8D%8F%E7%A8%8B%E6%B1%A0%E6%9C%BA%E5%88%B6.drawio.png",alt:""}})]),s._v(" "),t("p",[s._v("慎用协程池")]),s._v(" "),t("ul",[t("li",[s._v("Go语言的线程，已经相当于池化了")]),s._v(" "),t("li",[s._v("二级池化会增加系统复杂度")]),s._v(" "),t("li",[s._v("Go语言的初衷式希望协程即用即毁，不要池化")])]),s._v(" "),t("h3",{attrs:{id:"总结-5"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结-5"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("ul",[t("li",[s._v("太多的协程会给程序运行带来性能和稳定性问题")]),s._v(" "),t("li",[s._v("牺牲并发特性，利用channel缓冲")])]),s._v(" "),t("h2",{attrs:{id:"总结-6"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结-6"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("blockquote",[t("p",[s._v("为什么用协程")])]),s._v(" "),t("ul",[t("li",[s._v("协程用来精细利用线程（pc1000个线程暂用系统资源太大，但是如果是1000个协程是轻而易举的）")]),s._v(" "),t("li",[s._v("协程可以支撑超高并发")])]),s._v(" "),t("blockquote",[t("p",[s._v("协程是什么")])]),s._v(" "),t("ul",[t("li",[s._v("从runtime的角度看，协程是一个可以被调度的g结构体")]),s._v(" "),t("li",[s._v("从线程的角度看，协程是一段程序，自带执行现场")])]),s._v(" "),t("blockquote",[t("p",[s._v("G-M-P模型")])]),s._v(" "),t("ul",[t("li",[s._v("通过P结构体，达成了缓存部分G的目的")]),s._v(" "),t("li",[s._v("P本质上是一个G的本地队列，避免全局并发等待")]),s._v(" "),t("li",[s._v("窃取式工作分配机制能够更加充分利用线程资源")])]),s._v(" "),t("blockquote",[t("p",[s._v("协程并发")])]),s._v(" "),t("ul",[t("li",[s._v("如果协程顺序执行，会有饥饿问题")]),s._v(" "),t("li",[s._v("协程执行中间，将协程挂起，执行其他协程")]),s._v(" "),t("li",[s._v("完成系统调用时挂起，也可以主动挂起")]),s._v(" "),t("li",[s._v("防止全局队列饥饿，本地队列随机抽取全局队列")])]),s._v(" "),t("blockquote",[t("p",[s._v("抢占式调度")])]),s._v(" "),t("ul",[t("li",[s._v("基于系统调用和主动挂起，协程可能无法调度")]),s._v(" "),t("li",[s._v("基于协作的抢占式调度：业务主动调用morestack()")]),s._v(" "),t("li",[s._v("基于信号的抢占式调度：强制线程调用doSigPreempt()")])])])}),[],!1,null,null,null);t.default=r.exports}}]);
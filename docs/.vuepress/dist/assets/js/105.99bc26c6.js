(window.webpackJsonp=window.webpackJsonp||[]).push([[105],{393:function(s,a,t){"use strict";t.r(a);var n=t(14),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"高并发下的内存模型与垃圾回收"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#高并发下的内存模型与垃圾回收"}},[s._v("#")]),s._v(" 高并发下的内存模型与垃圾回收")]),s._v(" "),a("ul",[a("li",[s._v("栈内存(协程栈，调用栈)")]),s._v(" "),a("li",[s._v("堆内存")]),s._v(" "),a("li",[s._v("垃圾回收")])]),s._v(" "),a("h2",{attrs:{id:"为什么说go的栈在堆上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为什么说go的栈在堆上"}},[s._v("#")]),s._v(" 为什么说Go的栈在堆上？")]),s._v(" "),a("blockquote",[a("p",[s._v("GO协程栈的作用")])]),s._v(" "),a("ul",[a("li",[s._v("协程的执行路径")]),s._v(" "),a("li",[s._v("局部变量")]),s._v(" "),a("li",[s._v("函数传参")]),s._v(" "),a("li",[s._v("函数返回值")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E5%8D%8F%E7%A8%8B%E6%A0%88%E7%9A%84%E7%BB%93%E6%9E%84.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("执行完 sum 函数后，sum函数的栈帧就会回收")]),s._v(" "),a("blockquote",[a("p",[s._v("Go 协程栈的位置")])]),s._v(" "),a("ul",[a("li",[s._v("Go 协程栈位于 Go 堆内存上\n"),a("ul",[a("li",[s._v("c语言，栈与堆分开，栈由程序管理，堆由用户自己管理")]),s._v(" "),a("li",[s._v("go 自己的栈内存也是在堆上的，栈的内存也是由GC释放的")])])]),s._v(" "),a("li",[s._v("Go 堆内存位于操作系统虚拟内存（由操作系统分配）上")])]),s._v(" "),a("blockquote",[a("p",[s._v("参数传递")])]),s._v(" "),a("ul",[a("li",[s._v("Go 使用参数拷贝传递（值传递）")]),s._v(" "),a("li",[s._v("传递结构体时：会拷贝结构体中的全部内容")]),s._v(" "),a("li",[s._v("传递结构体指针是，会拷贝结构体指针")])]),s._v(" "),a("blockquote",[a("p",[s._v("总结")])]),s._v(" "),a("ul",[a("li",[s._v("协程栈记录了协程的执行现场")]),s._v(" "),a("li",[s._v("协程栈还负责记录局部变量，传递参数和返回值")]),s._v(" "),a("li",[s._v("Go 使用参数拷贝传递")])]),s._v(" "),a("blockquote",[a("p",[s._v("思考")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E5%8D%8F%E7%A8%8B%E6%A0%88.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("协程栈在空间上连续方，遇到不够大的情况怎么办？")]),s._v(" "),a("ul",[a("li",[s._v("本地变量太大（初始2K到4K）")]),s._v(" "),a("li",[s._v("栈帧太多")])]),s._v(" "),a("h2",{attrs:{id:"协程栈不够用了怎么办"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#协程栈不够用了怎么办"}},[s._v("#")]),s._v(" 协程栈不够用了怎么办？")]),s._v(" "),a("blockquote",[a("p",[s._v("局部变量太大")])]),s._v(" "),a("ul",[a("li",[s._v("不是所有变量都能放在协程栈上")]),s._v(" "),a("li",[s._v("栈帧回收后，需要继续使用的变量")]),s._v(" "),a("li",[s._v("太大的变量")])]),s._v(" "),a("p",[s._v("局部变量太大的情况可以通过逃逸分析解决。")]),s._v(" "),a("blockquote",[a("p",[s._v("逃逸分析")])]),s._v(" "),a("ul",[a("li",[s._v("指针逃逸")]),s._v(" "),a("li",[s._v("空接口逃逸")]),s._v(" "),a("li",[s._v("大变量逃逸")])]),s._v(" "),a("blockquote",[a("p",[s._v("逃逸分析 -> 指针逃逸")])]),s._v(" "),a("ul",[a("li",[s._v("函数返回了对象的指针")])]),s._v(" "),a("blockquote",[a("p",[s._v("逃逸分析 -> 空接逃逸")])]),s._v(" "),a("ul",[a("li",[s._v("如果函数的参数为interfacel{}")]),s._v(" "),a("li",[s._v("函数的实参很可能会逃逸")]),s._v(" "),a("li",[s._v("因为 interface{} 类型的函数往往会使用反射")])]),s._v(" "),a("blockquote",[a("p",[s._v("逃逸分析 -> 大变量逃逸")])]),s._v(" "),a("ul",[a("li",[s._v("过大的变量会导致栈空间不足")]),s._v(" "),a("li",[s._v("64 位机器中，一般超过 64 KB 的变量会逃逸")])]),s._v(" "),a("blockquote",[a("p",[s._v("栈帧太多")])]),s._v(" "),a("p",[s._v("解决方式为：栈扩容")]),s._v(" "),a("blockquote",[a("p",[s._v("栈扩容")])]),s._v(" "),a("ul",[a("li",[s._v("Go 栈的初始空间为 2KB")]),s._v(" "),a("li",[s._v("在函数调用前判断栈空间(morestack)")]),s._v(" "),a("li",[s._v("必要时对栈进行扩容")]),s._v(" "),a("li",[s._v("早期使用分段栈，后期使用连续栈")])]),s._v(" "),a("blockquote",[a("p",[s._v("分段栈")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E5%88%86%E6%AE%B5%E6%A0%88.drawio.png",alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("1.13 之前使用")]),s._v(" "),a("li",[s._v("优点：没有空间浪费")]),s._v(" "),a("li",[s._v("缺点：栈指针会在不连续的空间跳转")])]),s._v(" "),a("blockquote",[a("p",[s._v("连续栈")])]),s._v(" "),a("p",[s._v("找一个放的下两倍栈空间的空闲空间进行扩容")]),s._v(" "),a("ul",[a("li",[s._v("优点：空间一直连续")]),s._v(" "),a("li",[s._v("缺点：伸缩时的开销大")]),s._v(" "),a("li",[s._v("当空间不足时扩容，变为原来的2倍")]),s._v(" "),a("li",[s._v("当空间使用率不足1/4时缩容，变为原来的1/2")])]),s._v(" "),a("blockquote",[a("p",[s._v("总结")])]),s._v(" "),a("ul",[a("li",[s._v("三种特殊情况下，变量可能分配到堆上")]),s._v(" "),a("li",[s._v("1.13之前，Go使用可伸缩的分段栈")]),s._v(" "),a("li",[s._v("1.14以后，Go使用连续栈，伸缩时直接使用新栈")])]),s._v(" "),a("h2",{attrs:{id:"go的堆内存结构是怎样的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#go的堆内存结构是怎样的"}},[s._v("#")]),s._v(" Go的堆内存结构是怎样的？")]),s._v(" "),a("blockquote",[a("p",[s._v("操作系统虚拟内存")])]),s._v(" "),a("ul",[a("li",[s._v("不是Win的”虚拟内存“（类似linux的swap空间）")]),s._v(" "),a("li",[s._v("操作系统给应用提供的虚拟内存空间")]),s._v(" "),a("li",[s._v("背后是物理内存，也由可能由磁盘")]),s._v(" "),a("li",[s._v("Linux 获取虚拟内存：mmap、madvice")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98.drawio.png",alt:""}})]),s._v(" "),a("blockquote",[a("p",[s._v("heapArena")])]),s._v(" "),a("p",[s._v("arena 竞技场；斗兽场")]),s._v(" "),a("ul",[a("li",[s._v("Go每次申请的虚拟内存单元为64MB")]),s._v(" "),a("li",[s._v("最多由 4 194 304 个虚拟内存单元（2^20）")]),s._v(" "),a("li",[s._v("内存单元也叫 heapArena")]),s._v(" "),a("li",[s._v("所有的heapArena组成了mheap（Go 堆内存）")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/heapArena.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("一个heapArena暂用虚拟内存64MB，heapArena在虚拟内存的空间不一定连续，虚拟内存连续的空间对应的物理内存空间也不一定连续。")]),s._v(" "),a("p",[s._v("Go/src/runtime/mheap.go")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" mheap "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    allspans "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// all spans out there")]),s._v("\n\tarenas "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" arenaL1Bits"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" arenaL2Bits"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("heapArena\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" heapArena "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// bitmap stores the pointer/scalar bitmap for the words in")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// this arena. See mbitmap.go for a description. Use the")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// heapBits type to access this.")]),s._v("\n\tbitmap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("heapArenaBitmapBytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("byte")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("blockquote",[a("p",[s._v("如何使用heapArena（线性分配）")])]),s._v(" "),a("p",[s._v("采用线性分配，每次需要的空间都往后放，有些用不到的空间被释放时，还是继续往后放，直到放完，再看看之前又没有空间被释放，有的话继续分配。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E7%BA%BF%E6%80%A7%E5%88%86%E9%85%8D.drawio.png",alt:""}})]),s._v(" "),a("blockquote",[a("p",[s._v("链表分配")])]),s._v(" "),a("p",[s._v("将释放的的空间采用链表连接起来，用于下次分配，但是遇到装不下的大空间，需要采用线性分配，往后放。容易产生碎片化的空间。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E9%93%BE%E8%A1%A8%E5%88%86%E9%85%8D.drawio.png",alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("线性分配或者链表分配容易出现空间碎片")])]),s._v(" "),a("blockquote",[a("p",[s._v("分级分配")])]),s._v(" "),a("p",[s._v("不是go中具体实现。体现思想")]),s._v(" "),a("ul",[a("li",[s._v("如果最小的对象大小小于最小单元，直接分配最小单元。")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E5%88%86%E7%BA%A7%E6%80%9D%E6%83%B3.drawio.png",alt:""}})]),s._v(" "),a("blockquote",[a("p",[s._v("内存管理单元 mspan")])]),s._v(" "),a("ul",[a("li",[s._v("根据隔离适应策略，使用内存时的最小单位为mspan")]),s._v(" "),a("li",[s._v("每个mspan为N个相同大小的”格子“")]),s._v(" "),a("li",[s._v("Go 中一共有67中mspan")])]),s._v(" "),a("p",[s._v("1级的 mspan 最小分配空间时 8 个字节（bytes），每个格子最小可以存一个字节的东西，那么最大浪费可以达到百分之87.5%")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/mspan.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("分级内存示意：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/heapArena_%E5%88%86%E7%BA%A7.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("heapArena 并不是一开始就有所有的span，而是按需开辟")]),s._v(" "),a("blockquote",[a("p",[s._v("源码解析")])]),s._v(" "),a("p",[s._v("Go/src/runtime/sizeclasses.go")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// class  bytes/obj  bytes/span  objects  tail waste  max waste  min align")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//     1          8        8192     1024           0     87.50%          8")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//     2         16        8192      512           0     43.75%         16")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//     3         24        8192      341           8     29.24%          8")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("blockquote",[a("p",[s._v("内存管理单元 mspan")])]),s._v(" "),a("ul",[a("li",[s._v("每个heapArena中的mspan都不确定")]),s._v(" "),a("li",[s._v("如何快速找到所需的mspan级别？")])]),s._v(" "),a("blockquote",[a("p",[s._v("中心索引 mcentral")])]),s._v(" "),a("ul",[a("li",[s._v("136 个 mcentral 结构体，其中")]),s._v(" "),a("li",[s._v("68 个组需要GC扫描的 mspan")]),s._v(" "),a("li",[s._v("68 个组不需要GC扫描的 mspan")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/mcentral.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("源码：Go/src/runtime/mcentral.go")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("type mcentral struct {\n\tspanclass spanClass\n\tpartial [2]spanSet // 部分满的span\n\tfull    [2]spanSet // 全满的span   \n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("blockquote",[a("p",[s._v("mcentral 的性能问题")])]),s._v(" "),a("ul",[a("li",[s._v("mcentral 实际是中心索引，引用互斥锁保护")]),s._v(" "),a("li",[s._v("再高并发场景下，锁冲突问题严总")]),s._v(" "),a("li",[s._v("参考协程GMP模型，增加线程本地缓存")])]),s._v(" "),a("blockquote",[a("p",[s._v("线程缓存mcache")])]),s._v(" "),a("ul",[a("li",[s._v("每个P拥有一个mcache")]),s._v(" "),a("li",[s._v("一个mcache拥有136个mspan，其中")]),s._v(" "),a("li",[s._v("68个需要GC扫描的mspan")]),s._v(" "),a("li",[s._v("68个不需要GC扫描的mspan")])]),s._v(" "),a("p",[s._v("由于中央索引有并发问题，引入mcache，给每个P分配一个mcache，里头有136的mcetral里的各一个span，当需要存数据，直接再P的mcache里拿，满了 P 需要到mcentral里换。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/mcache.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("源码：C:/Program Files/Go/src/runtime/mcache.go")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" mcache "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    \talloc "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("numSpanClasses"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// numSpanClasses = 128")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("源码：C:/Program Files/Go/src/runtime/runtime2.go")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" p "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tmcache      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mcache\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("blockquote",[a("p",[s._v("总结")])]),s._v(" "),a("ul",[a("li",[s._v("Go 模仿了TCmalloc（c++用的，也是由谷歌开发的），建立了自己的堆内存架构")]),s._v(" "),a("li",[s._v("使用 heapArena 向操作系统申请内存")]),s._v(" "),a("li",[s._v("使用 heapArena时，以mspan为单位，防止碎片化")]),s._v(" "),a("li",[s._v("mcentral 是 mspan 们的中心索引")]),s._v(" "),a("li",[s._v("mcache 记录了分配给各个P的本地 mspan")])]),s._v(" "),a("h2",{attrs:{id:"go-是如何分配堆内存的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#go-是如何分配堆内存的"}},[s._v("#")]),s._v(" Go 是如何分配堆内存的？")]),s._v(" "),a("blockquote",[a("p",[s._v("对象分级")])]),s._v(" "),a("ul",[a("li",[s._v("Tiny 微对象（0， 16B） 无指针")]),s._v(" "),a("li",[s._v("Small 小对象 [16B, 32KB]")]),s._v(" "),a("li",[s._v("Large 大对象  （32KB， +∞）")])]),s._v(" "),a("p",[s._v("分配")]),s._v(" "),a("ul",[a("li",[s._v("微小对象分配至普通 mspan")]),s._v(" "),a("li",[s._v("大对象 量身定做 mspan （0 级 span）")])]),s._v(" "),a("blockquote",[a("p",[s._v("微对象分配")])]),s._v(" "),a("ul",[a("li",[s._v("从 mcache 拿到2级 mspan")]),s._v(" "),a("li",[s._v("将多个为对象合并成一个 16 Byte 存入")])]),s._v(" "),a("p",[s._v("源码：C:/Program Files/Go/src/runtime/malloc.go")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mallocgc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" typ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" needzero "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Pointer "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" size "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" maxSmallSize "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 是不是小于small对象的级别 ")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" noscan "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" size "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" maxTinySize "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 是不是微对象")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 注释中有说明将多个为对象合并成一个 16 Byte 存入")]),s._v("\n            span "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alloc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("tinySpanClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 那一个二级span")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 找到空闲的二级span，返回地址 v ")]),s._v("\n            v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" span"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" shouldhelpgc "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextFree")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tinySpanClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 小对象")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 查表该对象应该用几级的span")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" size "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" smallSizeMax"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t\tsizeclass "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" size_to_class8"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("divRoundUp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" smallSizeDiv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t\tsizeclass "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" size_to_class128"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("divRoundUp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("smallSizeMax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" largeSizeDiv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            spc "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("makeSpanClass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sizeclass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" noscan"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 找到对应等级的spanClass")]),s._v("\n            span "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alloc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// c 是 mcache，找该级别span")]),s._v("\n\t\t   v "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextFreeFast")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("span"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 找到span的下一个空闲的位置，并返回地址")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 大对象 逻辑， 开启 0 级 的span")]),s._v("\n        span "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("allocLarge")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" noscan"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mcache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("allocLarge")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" noscan "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    spc "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("makeSpanClass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" noscan"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 开辟0级 span")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mcache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextFree")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("spc spanClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v gclinkptr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" s "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" shouldhelpgc "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("refill")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// span满了，需要到mcentral里找到空闲的span进行交换 ")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mcache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("refill")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("spc spanClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 从中央索引找新的span")]),s._v("\n    s "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mheap_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("central"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mcentral"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cacheSpan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mcentral"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cacheSpan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// We failed to get a span from the mcentral so get one from mheap.")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 中央的 mcentral 也没有 mspan 了")]),s._v("\n\ts "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grow")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" s "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mcentral"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grow")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    s "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" mheap_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("alloc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("spanclass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("h "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mheap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("alloc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npages "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" spanclass spanClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\ts "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" h"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("allocSpan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" spanAllocHeap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" spanclass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" s\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("h "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mheap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("allocSpan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npages "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" typ spanAllocType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" spanclass spanClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n   growth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ok "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" h"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grow")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npages "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" extraPages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("h "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mheap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grow")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npage "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 增加 heapArena 一个 heapArena 大小为64M")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br")])]),a("p",[s._v("一级的span当前版本是用不到的")]),s._v(" "),a("blockquote",[a("p",[s._v("mecache 的替换")])]),s._v(" "),a("ul",[a("li",[s._v("mcache 中，每个级别的mspan中只有一个")]),s._v(" "),a("li",[s._v("当mspan满了之后，会从 mcentral 中换一个新的")])]),s._v(" "),a("blockquote",[a("p",[s._v("mcentral 的扩容")])]),s._v(" "),a("ul",[a("li",[s._v("mcentral中，只有有限数量的mspan")]),s._v(" "),a("li",[s._v("当mspan缺少时，会从heapArena开辟新的mspan")])]),s._v(" "),a("blockquote",[a("p",[s._v("大对象的分配")])]),s._v(" "),a("ul",[a("li",[s._v("直接从 heapArena 开辟 0 级的 mspan")]),s._v(" "),a("li",[s._v("0 级的 mspan 为大对象定制")])]),s._v(" "),a("blockquote",[a("p",[s._v("heapArena 的扩充")])]),s._v(" "),a("ul",[a("li",[s._v("当 heapArena 空间不足时")]),s._v(" "),a("li",[s._v("向操作系统申请新的heapArena")])]),s._v(" "),a("blockquote",[a("p",[s._v("总结")])]),s._v(" "),a("ul",[a("li",[s._v("Go 将对象按照大小分为3种")]),s._v(" "),a("li",[s._v("微小对象使用mcache")]),s._v(" "),a("li",[s._v("mcache中的mspan填满后，与mcentral交换新的")]),s._v(" "),a("li",[s._v("mcentral 不足时，再heapArena开辟新的mspan")]),s._v(" "),a("li",[s._v("大对象直接再heapArena开辟新的mspan")])]),s._v(" "),a("h2",{attrs:{id:"什么对象需要垃圾回收"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么对象需要垃圾回收"}},[s._v("#")]),s._v(" 什么对象需要垃圾回收？")]),s._v(" "),a("blockquote",[a("p",[s._v("垃圾回收（Garbage Collecting）思路")])]),s._v(" "),a("ul",[a("li",[s._v("标记-清除")]),s._v(" "),a("li",[s._v("标记-整理")]),s._v(" "),a("li",[s._v("复制")])]),s._v(" "),a("blockquote",[a("p",[s._v("标记-清除")])]),s._v(" "),a("p",[s._v("标记没有引用的数据，进行清除")]),s._v(" "),a("p",[s._v("缺点：如果是其他语言可能会产生碎片的问题")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4.drawio.png",alt:""}})]),s._v(" "),a("blockquote",[a("p",[s._v("标记-整理")])]),s._v(" "),a("p",[s._v("标记清除后，再对空间再次进行整理")]),s._v(" "),a("p",[s._v("缺点：开销大（java老年代使用的标记整理，因为GC的次数少）")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86.drawio-1677169154980199.png",alt:""}})]),s._v(" "),a("blockquote",[a("p",[s._v("复制")])]),s._v(" "),a("p",[s._v("标记删除的数据，将需要的数据复制到新空间，并进行了整理（JAVA新生代在用，但是并不是成倍拷贝）")]),s._v(" "),a("p",[s._v("缺点：空间浪费")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E6%A0%87%E8%AE%B0%E5%A4%8D%E5%88%B6.drawio.png",alt:""}})]),s._v(" "),a("blockquote",[a("p",[s._v("Go 中的垃圾回收机制")])]),s._v(" "),a("ul",[a("li",[s._v("Go因为堆内存结构的独特优势，选择最简单的标记-清除")]),s._v(" "),a("li",[s._v("找到有引用的对象。剩下的就是没有引用的。")])]),s._v(" "),a("blockquote",[a("p",[s._v("从哪开始找")])]),s._v(" "),a("ul",[a("li",[s._v("被栈上的指针引用")]),s._v(" "),a("li",[s._v("被全局变量指针引用")]),s._v(" "),a("li",[s._v("被寄存器中的指针引用")]),s._v(" "),a("li",[s._v("上述变量被称为 Root Set （GC Root）")])]),s._v(" "),a("blockquote",[a("p",[s._v("怎么找")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/GC_root.drawio.png",alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("Root 节点进行广度优先搜索 BFS")]),s._v(" "),a("li",[s._v("这种方法也叫可达性分析标记法")])]),s._v(" "),a("blockquote",[a("p",[s._v("串行GC 步骤")])]),s._v(" "),a("ul",[a("li",[s._v("Stop The World， 暂停所有其他协程")]),s._v(" "),a("li",[s._v("通过可达性分析，找到无用的堆内存")]),s._v(" "),a("li",[s._v("释放堆内存")]),s._v(" "),a("li",[s._v("恢复所有其他协程")])]),s._v(" "),a("p",[s._v("问题：")]),s._v(" "),a("ul",[a("li",[s._v("STW 对性影响大（Go 每隔几十毫秒或者几百毫秒就要停下来进行GC的话）")])]),s._v(" "),a("blockquote",[a("p",[s._v("总结")])]),s._v(" "),a("ul",[a("li",[s._v("从GC Root 出发，寻找被引用对象")]),s._v(" "),a("li",[s._v("没有被引用的就是无用对象")]),s._v(" "),a("li",[s._v("串行GC需要STW，对性能影响大")])]),s._v(" "),a("h2",{attrs:{id:"如何减小gc对性能的影响"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何减小gc对性能的影响"}},[s._v("#")]),s._v(" 如何减小GC对性能的影响？")]),s._v(" "),a("blockquote",[a("p",[s._v("并发垃圾回收")])]),s._v(" "),a("ul",[a("li",[s._v("并发的难点在于标记阶段")])]),s._v(" "),a("blockquote",[a("p",[s._v("三色标记法")])]),s._v(" "),a("ul",[a("li",[s._v("黑色：有用，已经分析扫描")]),s._v(" "),a("li",[s._v("灰色：有用，还未分析扫描")]),s._v(" "),a("li",[s._v("展示无用")])]),s._v(" "),a("p",[s._v("起初所有的对象都是白色的")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E8%B5%B7%E5%88%9D%E9%83%BD%E6%98%AF%E7%99%BD%E8%89%B2%E7%9A%84.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("从根对象出发扫描可达对象，标记为灰色")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E6%A0%B9%E8%8A%82%E7%82%B9%E5%87%BA%E5%8F%91%E6%A0%87%E8%AE%B0%E4%B8%BA%E7%81%B0%E8%89%B2.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("扫描灰色对象，将其引用的对象标记为灰色，自身标记为黑色")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E6%89%AB%E6%8F%8F%E7%81%B0%E8%89%B2%E5%B9%B6%E6%A0%87%E8%AE%B0%E8%87%AA%E8%BA%AB%E4%B8%BA%E9%BB%91%E8%89%B2.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("继续扫描")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E7%BB%A7%E7%BB%AD%E6%89%AB%E6%8F%8F%E7%81%B0%E8%89%B2%E5%AF%B9%E8%B1%A1.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("清除白色对象")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E6%B8%85%E9%99%A4%E7%99%BD%E8%89%B2%E5%AF%B9%E8%B1%A1.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("再次标记时，，所有对象恢复为白色")]),s._v(" "),a("blockquote",[a("p",[s._v("并发标记问题（删除）")])]),s._v(" "),a("p",[s._v("并发标记进行中")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E5%B9%B6%E5%8F%91%E6%A0%87%E8%AE%B0%E8%BF%9B%E8%A1%8C%E4%B8%AD.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("业务：B指向C的指针释放")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E4%B8%9A%E5%8A%A1%E9%87%8A%E6%94%BE%E6%8C%87%E9%92%88.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("业务：E的一个指针成员指向了C")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E4%B8%9A%E5%8A%A1%E6%96%B0%E5%A2%9E%E6%8C%87%E9%92%88.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("继续扫描")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E7%BB%A7%E7%BB%AD%E6%89%AB%E6%8F%8F.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("由于E已经扫描过了，C还是白色，C被错误删除")]),s._v(" "),a("blockquote",[a("p",[s._v("Yuase 删除屏障")])]),s._v(" "),a("ul",[a("li",[s._v("并发标记时")]),s._v(" "),a("li",[s._v("对指针释放的白色对象置灰")])]),s._v(" "),a("p",[s._v("c被删除时，删除屏障会把C标记为灰")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E5%88%A0%E9%99%A4%E5%B1%8F%E9%9A%9C%E6%A0%87%E8%AE%B0%E4%B8%BA%E7%81%B0%E8%89%B2.drawio.png",alt:""}})]),s._v(" "),a("blockquote",[a("p",[s._v("并发标记问题（插入）")])]),s._v(" "),a("p",[s._v("在烧苗完E对象后，有业务对E新增了指向C的指针")]),s._v(" "),a("p",[a("img",{attrs:{src:"/2_5_memory_model_and_garbage_collection.assets/%E5%B9%B6%E5%8F%91%E6%8F%92%E5%85%A5%E6%A0%87%E8%AE%B0%E9%97%AE%E9%A2%98.drawio.png",alt:""}})]),s._v(" "),a("p",[s._v("此事 C 也会因此被误删除")]),s._v(" "),a("blockquote",[a("p",[s._v("Dijkstra 插入屏障")])]),s._v(" "),a("ul",[a("li",[s._v("并发标记时")]),s._v(" "),a("li",[s._v("对指针新指向的白色对象置灰")]),s._v(" "),a("li",[s._v("插入屏障可以杜绝在GC标记中被插入的指针，被清理")])]),s._v(" "),a("blockquote",[a("p",[s._v("混合屏障")])]),s._v(" "),a("ul",[a("li",[s._v("被删除的对对象标记为灰色")]),s._v(" "),a("li",[s._v("被添加的堆对象标记为灰色")])]),s._v(" "),a("blockquote",[a("p",[s._v("总结")])]),s._v(" "),a("ul",[a("li",[s._v("并发垃圾会搜的关键在于标记安全")]),s._v(" "),a("li",[s._v("混合屏障机制兼顾了安全与效率")])]),s._v(" "),a("h2",{attrs:{id:"实战-如何优化gc效率"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实战-如何优化gc效率"}},[s._v("#")]),s._v(" 实战：如何优化GC效率？")]),s._v(" "),a("blockquote",[a("p",[s._v("GC触发的时机")])]),s._v(" "),a("ul",[a("li",[s._v("系统定时触发")]),s._v(" "),a("li",[s._v("用户显示触发")]),s._v(" "),a("li",[s._v("申请内存时触发")])]),s._v(" "),a("blockquote",[a("p",[s._v("系统定时触发")])]),s._v(" "),a("ul",[a("li",[s._v("sysmon定时检查（runtime背后的循环，g0协程执行）")]),s._v(" "),a("li",[s._v("如果两分钟内没有过GC，触发")]),s._v(" "),a("li",[s._v("谨慎调整")])]),s._v(" "),a("p",[s._v("源码：C:/Program Files/Go/src/runtime/proc.go")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// This is a variable for testing purposes. It normally doesn't change.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" forcegcperiod "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1e9")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 两分钟")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("blockquote",[a("p",[s._v("用户显示触发")])]),s._v(" "),a("ul",[a("li",[s._v("用户调用runtime.GC方法")]),s._v(" "),a("li",[s._v("并不推荐调用")])]),s._v(" "),a("blockquote",[a("p",[s._v("申请内存时触发")])]),s._v(" "),a("p",[s._v("源码：C:/Program Files/Go/src/runtime/malloc.go")]),s._v(" "),a("p",[s._v("分配内存用的函数后缀还跟了gc，是因为分配内存时如果空间不够了，那么会申请内存并进行一次gc")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mallocgc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" typ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" needzero "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Pointer "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("blockquote",[a("p",[s._v("GC 优化的原则")])]),s._v(" "),a("p",[s._v("尽量少在对上生产垃圾")]),s._v(" "),a("ul",[a("li",[s._v("内存池化")]),s._v(" "),a("li",[s._v("减少逃逸")]),s._v(" "),a("li",[s._v("使用空结构体")])]),s._v(" "),a("blockquote",[a("p",[s._v("内存池化")])]),s._v(" "),a("ul",[a("li",[s._v("缓存性质的对象（chanl的缓存区，环形缓存）")]),s._v(" "),a("li",[s._v("频繁创建和删除")]),s._v(" "),a("li",[s._v("使用内存池，不GC")])]),s._v(" "),a("blockquote",[a("p",[s._v("减少逃逸")])]),s._v(" "),a("ul",[a("li",[s._v("逃逸会使原来在栈上的ui想进入堆中")]),s._v(" "),a("li",[s._v("fmt包（需要慎用，尽量用log组件）")]),s._v(" "),a("li",[s._v("返回了指针而不是拷贝")])]),s._v(" "),a("blockquote",[a("p",[s._v("使用空结构体")])]),s._v(" "),a("ul",[a("li",[s._v("空结构体指向一个固定地址")]),s._v(" "),a("li",[s._v("不占用堆空间")]),s._v(" "),a("li",[s._v("比如channel传递空结构体")])]),s._v(" "),a("blockquote",[a("p",[s._v("GC 分析工具")])]),s._v(" "),a("ul",[a("li",[s._v("go tool pprof")]),s._v(" "),a("li",[s._v("go tool trace")]),s._v(" "),a("li",[s._v('go build -gcflags="-m"')]),s._v(" "),a("li",[s._v('GODEBUG="gctrace=1"  --- 简单粗暴好用')])]),s._v(" "),a("blockquote",[a("p",[s._v("实列")])]),s._v(" "),a("p",[s._v("代码：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\twg "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" sync"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WaitGroup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\twg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("wg "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sync"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WaitGroup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" count "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1e10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t\tcount"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\t\twg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("wg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("设置环境：")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[s._v("set GODEBUG"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("gctrace"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" run mian"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("查看信息")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[s._v("gc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" @"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("020s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.5")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ms clock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.5")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ms cpu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" MB goal"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" MB stacks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" MB globals"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" P\n \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("020s   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 启动到现在的时间")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//检测前-检测中-完成gc 内存占用的空间")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" P       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 当前有几个线程")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// GC 占用的时间")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("blockquote",[a("p",[s._v("总结")])]),s._v(" "),a("ul",[a("li",[s._v("GC主要由系统定时触发或者申请内存触发")]),s._v(" "),a("li",[s._v("GC优化的原则是减少在对上产生垃圾")]),s._v(" "),a("li",[s._v("使用GC分析工具可以帮助分析GC问题")])]),s._v(" "),a("h2",{attrs:{id:"本章小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#本章小结"}},[s._v("#")]),s._v(" 本章小结")]),s._v(" "),a("blockquote",[a("p",[s._v("协程栈")])]),s._v(" "),a("ul",[a("li",[s._v("协程栈记录协程的执行现场")]),s._v(" "),a("li",[s._v("Go 协程栈位于 Go 堆内存上")]),s._v(" "),a("li",[s._v("Go 使用参数拷贝传递")]),s._v(" "),a("li",[s._v("3中特殊情况下，变量可能会逃逸到堆上")]),s._v(" "),a("li",[s._v("1.14 以后， Go 使用连续栈，伸缩时直接使用新栈")])]),s._v(" "),a("blockquote",[a("p",[s._v("堆内存结构")])]),s._v(" "),a("ul",[a("li",[s._v("Go 模仿了TCmalloc，建立了自己的堆内存架构")]),s._v(" "),a("li",[s._v("使用 heapArena 向操作系统申请内存")]),s._v(" "),a("li",[s._v("使用 heapArena 时，以mspan 为单位，防止碎片化")]),s._v(" "),a("li",[s._v("mcentral 时 mspan 们的中心索引")]),s._v(" "),a("li",[s._v("mcache 记录了分配给各个 P 的本地 mspan")])]),s._v(" "),a("blockquote",[a("p",[s._v("堆内存分配")])]),s._v(" "),a("ul",[a("li",[s._v("Go 将对象按照大小分为3种")]),s._v(" "),a("li",[s._v("微小对象使用 mcache")]),s._v(" "),a("li",[s._v("mcache 种的 mspan 填满后，与mcentral交换新的")]),s._v(" "),a("li",[s._v("mcentral 不足时，在heapArena 开辟新的 mspan")]),s._v(" "),a("li",[s._v("大对象直接在 heapArena 开辟新的 mspan")])]),s._v(" "),a("blockquote",[a("p",[s._v("堆内存回收（GC）")])]),s._v(" "),a("ul",[a("li",[s._v("标记-清除法\n"),a("ul",[a("li",[s._v("标记有用对象，清除无用对象")])])]),s._v(" "),a("li",[s._v("可达性分析标记法\n"),a("ul",[a("li",[s._v("从 GC Root 出发，寻找被引用对象")])])])]),s._v(" "),a("blockquote",[a("p",[s._v("并发GC")])]),s._v(" "),a("ul",[a("li",[s._v("并发垃圾回收的关键在于标记安全")]),s._v(" "),a("li",[s._v("回合兵长机制兼顾了安全与效率")])]),s._v(" "),a("blockquote",[a("p",[s._v("GC 优化")])]),s._v(" "),a("ul",[a("li",[s._v("GC 主要由系统定时触发或者申请内存触发")]),s._v(" "),a("li",[s._v("GC 优化的原则时减少在堆上产生的垃圾")]),s._v(" "),a("li",[s._v("使用 GC 分析工具可以帮助分析GC问题")])])])}),[],!1,null,null,null);a.default=e.exports}}]);
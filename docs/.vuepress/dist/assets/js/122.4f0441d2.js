(window.webpackJsonp=window.webpackJsonp||[]).push([[122],{409:function(t,a,s){"use strict";s.r(a);var r=s(14),_=Object(r.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"微服务设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微服务设计"}},[t._v("#")]),t._v(" 微服务设计")]),t._v(" "),a("h2",{attrs:{id:"api-gateway"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#api-gateway"}},[t._v("#")]),t._v(" API Gateway")]),t._v(" "),a("h3",{attrs:{id:"垂直拆分"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#垂直拆分"}},[t._v("#")]),t._v(" 垂直拆分")]),t._v(" "),a("p",[a("img",{attrs:{src:"/overview_2_desgin.assets/micro_design_1.drawio.png",alt:""}})]),t._v(" "),a("p",[t._v("我们进行了SOA服务化的架构演进，按照垂直功能进行了拆分，对外暴露了一批微服务，但是因为缺乏统一的出口面临了不少困难：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("客户端到微服务直接通信，强耦合。")])]),t._v(" "),a("li",[a("strong",[t._v("需要多次请求，客户端聚合数据，工作量巨大，延迟高。")])]),t._v(" "),a("li",[a("strong",[t._v("协议不利于统一，各个部门间有差异，需要端来兼容。")])]),t._v(" "),a("li",[a("strong",[t._v("面向“端”的API适配，耦合到了内部服务。")])]),t._v(" "),a("li",[a("strong",[t._v("多终端兼容逻辑复杂，每个服务都需要处理。")])]),t._v(" "),a("li",[a("strong",[t._v("统一逻辑无法收敛，比如安全认证，限流。")])])]),t._v(" "),a("p",[t._v("我们之前提到了工作模型，需要内聚模式配合。")]),t._v(" "),a("h3",{attrs:{id:"统一协议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#统一协议"}},[t._v("#")]),t._v(" 统一协议")]),t._v(" "),a("p",[a("img",{attrs:{src:"/overview_2_desgin.assets/micro_bff.drawio.png",alt:""}})]),t._v(" "),a("p",[t._v("我们新增了一个 app-interface 用于统一的协议出口，在服务内进行大量的dataset join，按照业务场景设计粗粒度的API，给后续服务的演进带来很多优势：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("轻量交互:协议精简，聚合。")])]),t._v(" "),a("li",[a("strong",[t._v("差异服务：数据剪裁及聚合、针对终端定制化API。")])]),t._v(" "),a("li",[a("strong",[t._v("动态升级：原有系统兼容升级，更新服务而非协议。")])]),t._v(" "),a("li",[a("strong",[t._v("沟通效率提升，写作模式演进为移动业务+网关小组。")])])]),t._v(" "),a("p",[t._v("BFF 可以认为是一种适配服务，将后端的未付进行适配（主要包括集合）")]),t._v(" "),a("h3",{attrs:{id:"单点故障"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#单点故障"}},[t._v("#")]),t._v(" 单点故障")]),t._v(" "),a("p",[a("img",{attrs:{src:"/overview_2_desgin.assets/micro_single_failed.drawio.png",alt:""}})]),t._v(" "),a("p",[t._v("最致命的一个问题是整个app-interface 属于 single point of failure，严重的代码缺陷或者流量洪峰可能引发集群宕机。")]),t._v(" "),a("ul",[a("li",[t._v("单个模块会导致后续业务集成复杂度高，以及康威法则，单块的无线BFF和多团队之间就出现不匹配为题，团队之间沟通协调成本高，交付率低下。")]),t._v(" "),a("li",[t._v("很多横切面逻辑，比如安全认证，日志监控，限流熔断等。随着时间的推移，代码变得越来越复杂，技术债越堆越多。")])]),t._v(" "),a("h3",{attrs:{id:"通用功能服务层"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通用功能服务层"}},[t._v("#")]),t._v(" 通用功能服务层")]),t._v(" "),a("p",[a("img",{attrs:{src:"/overview_2_desgin.assets/micro_api_gateway.drawio.png",alt:""}})]),t._v(" "),a("p",[a("strong",[t._v("跨横切面（Cross-Cutting Concerns）的功能，需要协调新的框架升级发版")]),t._v("（路由，认证，限流，安全），因此全部上沉，引入了 API Gateway，把业务集成度高的BFF层和通用功能服务层API Gateway 进行了分层处理。")]),t._v(" "),a("p",[t._v("在新的架构中，网关承担了重要的角色，他是解耦拆分和后续升级迁移的利器。在网关的配合下，单块BFF实现了解耦拆分，各业务线团队可以独立开发和交付各自的微服务，研发效率大大提升。另外，把跨横切面逻辑从BFF剥离到网关上去以后，BFF的开发人员可以更加专注业务逻辑交付，实现了"),a("strong",[t._v("架构上的关注分离")]),t._v("（Separation of Concerns）。")]),t._v(" "),a("p",[a("strong",[t._v("业务的流量实际为：")])]),t._v(" "),a("p",[a("strong",[t._v("移动端 -> API Gateway -> BFF -> Mircoservice，在FE Web 业务中，BFF 可以是 nodejs 来做服务端渲染（SSR， Server-Side Rendering）,  注意这里忽略了上游的 CDN、4/7层负载均衡（ELB）")])]),t._v(" "),a("h2",{attrs:{id:"微服务划分"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微服务划分"}},[t._v("#")]),t._v(" 微服务划分")]),t._v(" "),a("h3",{attrs:{id:"通常划分"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通常划分"}},[t._v("#")]),t._v(" 通常划分")]),t._v(" "),a("p",[a("img",{attrs:{src:"/overview_2_desgin.assets/micro_common_depart.drawio.png",alt:""}})]),t._v(" "),a("p",[t._v("微服务架构时遇到的第一个问题就是如何划分微服务边界。在实际项目中通常会采用两种不同的划分服务边界，即通过业务只能（Business Capability）或是 DDD 的衔接上下文（Bounded Context）。")]),t._v(" "),a("ul",[a("li",[t._v("Business Capability\n"),a("ul",[a("li",[t._v("由公司内部不同部门提供的职能。例如客户服务部门提供客户服务的职能，财务部门提供财务相关的职能。")])])]),t._v(" "),a("li",[t._v("Bounded Context\n"),a("ul",[a("li",[t._v("限界上下文是 DDD 中用来划分不同业务边界的元素，这里业务边界的含义是“解决不同业务问题”的问题域和对应的解决方案域，为了解决某种类型的业务问题，贴近领域知识，也就是业务。")])])])]),t._v(" "),a("p",[t._v("这本质上也促进了组织结构的演进：Service perteam")]),t._v(" "),a("h3",{attrs:{id:"cqrs划分"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cqrs划分"}},[t._v("#")]),t._v(" CQRS划分")]),t._v(" "),a("p",[a("img",{attrs:{src:"/overview_2_desgin.assets/micro_cqrs.drawio.png",alt:""}})]),t._v(" "),a("p",[t._v("CQRS，将应用程序分为两部分：命令端和查询端。命令端处理程序创建，更新和删除请求，并在数据更改时发出事件。查询端通过针对一个或多个物化视图执行查询来处理查询，这些物化视图通过订阅数据更改时发出的事件流而保持最新。")]),t._v(" "),a("p",[t._v("在稿件服务演进过程中，我们发现围绕着创作稿件、审核稿件，最终发布稿件有大量的逻辑揉在一块，其中稿件本身的状态也非常多种，但是最终前台用户只关注稿件能否查看，我们依赖稿件数据库 binlog 以及订阅 binlog 的中间件 canal，将我们的稿件结果发部到消息队列kafka中，最终消费数据独立组件一个稿件查询结果数据，并对外提供一个独立查询服务，来拆分复杂架构和业务。")]),t._v(" "),a("p",[t._v("我们架构也从 Polling publisher -> Transaction log tailing 进行了演进(Pull vs Push)")]),t._v(" "),a("p",[t._v("Polling publisher: 定时服务监控id对应的时间段产生的新数据。")])])}),[],!1,null,null,null);a.default=_.exports}}]);